# Makefile.kbuild
# Pre-builds binary.a for whatever target, then uses the kernel build
# system to create the modules linmodem.ko, ess.ko and ess_hw.ko.

MODULE_DIR=$(DESTDIR)/lib/modules/$(KERNEL_VER)/misc

CFLAGS += -DVERSION=\"$(VERSION)\" -mhard-float

ifeq ($(DEBUG),1)
CFLAGS += -DLINMODEM_DEBUG=1 -DESS_DEBUG=1
endif

BIN_DIR = lib/

obj-m += linmodem.o
obj-m += esscom.o
obj-m += esscom_hw.o
linmodem-objs := linmodem-2.6.o
esscom-objs := essserial-2.6.o essserial_pci.o
esscom_hw-objs := binary.a essserial_hw.o

BIN_OBJS = $(BIN_DIR)esscom_bin.2.6.o

EXTRA_LDFLAGS := -z muldefs

all: 	binary.a
	make -C $(KERNEL_DIR) M=$(PWD)

verbose: binary.a
	make -C $(KERNEL_DIR) M=$(PWD) V=1

clean:
	rm -f linmodem-2.6.o essserial-2.6.o essserial_hw.o essserial_pci.o
	rm -f linmodem.o esscom.o esscom_hw.o
	rm -f linmodem.ko esscom.ko esscom_hw.ko
	rm -f linmodem.mod.c esscom.mod.c esscom_hw.mod.c
	rm -f linmodem.mod.o esscom.mod.o esscom_hw.mod.o
	rm -f .built-in.o.cmd built-in.o
	rm -f .esscom.ko.cmd .esscom.mod.o.cmd .esscom.o.cmd
	rm -f .esscom_hw.ko.cmd .esscom_hw.mod.o.cmd .esscom_hw.o.cmd
	rm -f .linmodem.ko.cmd .linmodem.mod.o.cmd .linmodem.o.cmd
	rm -f .linmodem-2.6.o.cmd .essserial-2.6.o.cmd .essserial_hw.o.cmd
	rm -f .essserial_pci.o.cmd
	rm -rf .tmp_versions
	rm -f binary.a

.s.o:
	@echo "  CC	$@"
	@gcc -c $< -o $@

# how to take a 111.zip (unmodified 2.2 distribution) and create a linkable object file
# two step process: first, run objcopy, then run a special program to manipulate relocs
# and make changes to the binary

binary.a: $(BIN_DIR)esscom_bin.2.6.o
	@echo "  LD	binary.a"
	@ld -d -i $(BIN_OBJS) -o binary.a

insmod:
	/sbin/insmod linmodem.ko
	/sbin/insmod esscom_hw.ko
	/sbin/insmod esscom.ko

rmmod:
	/sbin/rmmod esscom
	/sbin/rmmod esscom_hw
	/sbin/rmmod linmodem

install:
	rm -f /dev/ttyS_ESS0
ifdef UDEV
	echo "KERNEL=\"ttyS_ESS0\", SYMLINK=\"modem\"" > /etc/udev/rules.d/ess.rules
else
	mknod /dev/ttyS_ESS0 c 62 64
	chmod 666 /dev/ttyS_ESS0
	ln -sf /dev/ttyS_ESS0 /dev/modem
endif
	install -D -m 644 linmodem.ko $(MODULE_DIR)/linmodem.ko
	install -D -m 644 esscom.ko $(MODULE_DIR)/esscom.ko
	install -D -m 644 esscom_hw.ko $(MODULE_DIR)/esscom_hw.ko
	/sbin/depmod -a

uninstall:
	/sbin/modprobe -r esscom ; echo -n
	/sbin/modprobe -r esscom_hw ; echo -n
	/sbin/modprobe -r linmodem ; echo -n
	$(RM) $(MODULE_DIR)/linmodem.ko
	$(RM) $(MODULE_DIR)/esscom_hw.ko
	$(RM) $(MODULE_DIR)/esscom.ko
	/sbin/depmod -a
ifdef UDEV
	rm /etc/udev/rules.d/ess.rules
else
	rm -f /dev/modem /dev/ttyS_ESS0
endif

